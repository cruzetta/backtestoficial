<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day Trade - Dólar em Tempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 48px; height: 48px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-container { position: relative; height: 60vh; width: 100%; }
        .day-trade-info-value.positive { color: #22c55e; }
        .day-trade-info-value.negative { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8">

    <div id="loadingScreen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="text-center max-w-2xl">
            <div class="loader inline-block"></div>
            <div id="loadingStatus" class="text-gray-400 mt-4 text-lg">Conectando e carregando dados...</div>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <header class="max-w-7xl mx-auto text-center mb-6 relative">
            <h1 id="mainTitle" class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">Simulação Day Trade - Dólar (USD/BRL)</h1>
            <div class="absolute top-0 left-0">
                <a href="./index.html" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 px-3 rounded-lg inline-flex items-center transition">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar para Backtest
                </a>
            </div>
            <div class="absolute top-0 right-0">
                 <p id="userEmail" class="text-xs text-gray-500 mb-1"></p>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-lg inline-flex items-center transition">
                     <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                     Logout
                </button>
            </div>
        </header>

        <div id="dayTradePage" class="max-w-7xl mx-auto mt-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3 bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-center text-gray-200">Gráfico em Tempo Real - Dólar (USD/BRL)</h3>
                    <div class="chart-container"><canvas id="dayTradeChart"></canvas></div>
                </div>

                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-lg mb-4 text-gray-200">Boleta de Ordens</h3>
                        <div class="bg-gray-900/50 p-3 rounded-lg text-center mb-4">
                            <p class="text-sm text-gray-400">Preço Atual (Compra)</p>
                            <p id="currentPriceDisplay" class="text-2xl font-bold text-yellow-400">--.----</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label for="orderQuantity" class="block mb-1 text-sm font-medium text-gray-300">Quantidade (USD)</label>
                                <input type="number" id="orderQuantity" value="100" min="1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                            <div class="flex gap-3">
                                <button id="buyBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">COMPRAR</button>
                                <button id="sellBtn" class="flex-1 bg-red-600 hover:red-700 text-white font-bold py-3 rounded-lg transition">VENDER</button>
                            </div>
                            <div class="flex gap-3 pt-2">
                                 <button id="closePositionBtn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg transition">ZERAR</button>
                                 <button id="reversePositionBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg transition">REVERTER</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-lg mb-4 text-gray-200">Posição Atual</h3>
                        <div id="positionInfo" class="space-y-2 text-sm">
                            <div class="flex justify-between items-center"><span class="text-gray-400">Posição:</span><span id="posStatus" class="font-semibold">Zerado</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400">Quantidade:</span><span id="posQuantity" class="font-semibold">0</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400">Preço Médio:</span><span id="posAvgPrice" class="font-semibold">0.0000</span></div>
                            <hr class="border-gray-700 my-2">
                            <div class="flex justify-between items-center"><span class="text-gray-400">Resultado Aberto:</span><span id="posOpenPnl" class="font-bold text-lg day-trade-info-value">R$ 0,00</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400">Resultado do Dia:</span><span id="posClosedPnl" class="font-bold text-lg day-trade-info-value">R$ 0,00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCMIdzeoPFrT8WRElUBes7GTrcsoGzLBiI",
            authDomain: "backtest-f5072.firebaseapp.com",
            projectId: "backtest-f5072",
            storageBucket: "backtest-f5072.appspot.com",
            messagingSenderId: "694914388064",
            appId: "1:694914388064:web:e5ac46c00612142d33b305",
            measurementId: "G-YD1CYX3455"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let dayTradeChart = null;
        let dataFetchInterval = null;
        let dayTradeState = {};
        const MAX_CHART_POINTS = 100; // Limita o número de pontos no gráfico para não sobrecarregar

        const ui = {
            loadingScreen: document.getElementById('loadingScreen'),
            appContainer: document.getElementById('appContainer'),
            userEmail: document.getElementById('userEmail'),
            logoutBtn: document.getElementById('logoutBtn'),
            dayTradeChart: document.getElementById('dayTradeChart'),
            currentPriceDisplay: document.getElementById('currentPriceDisplay'),
            orderQuantity: document.getElementById('orderQuantity'),
            buyBtn: document.getElementById('buyBtn'),
            sellBtn: document.getElementById('sellBtn'),
            closePositionBtn: document.getElementById('closePositionBtn'),
            reversePositionBtn: document.getElementById('reversePositionBtn'),
            posStatus: document.getElementById('posStatus'),
            posQuantity: document.getElementById('posQuantity'),
            posAvgPrice: document.getElementById('posAvgPrice'),
            posOpenPnl: document.getElementById('posOpenPnl'),
            posClosedPnl: document.getElementById('posClosedPnl'),
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                ui.userEmail.textContent = user.email;
                ui.loadingScreen.classList.add('hidden');
                ui.appContainer.classList.remove('hidden');

                resetDayTradeState();
                setupDayTradeChart();
                
                // Inicia a busca de dados em tempo real
                await fetchRealTimeDolarData(); // Busca a primeira vez
                if (dataFetchInterval) clearInterval(dataFetchInterval);
                dataFetchInterval = setInterval(fetchRealTimeDolarData, 10000); // Atualiza a cada 10 segundos

            } else {
                window.location.href = './index.html';
            }
        });
        
        ui.logoutBtn.addEventListener('click', () => {
            if (dataFetchInterval) clearInterval(dataFetchInterval);
            signOut(auth);
        });

        async function fetchRealTimeDolarData() {
            try {
                const response = await fetch('https://economia.awesomeapi.com.br/last/USD-BRL');
                if (!response.ok) throw new Error('Falha na rede');
                const data = await response.json();
                const newPrice = parseFloat(data.USDBRL.bid);

                // Atualiza o estado e a UI
                dayTradeState.currentPrice = newPrice;
                ui.currentPriceDisplay.textContent = newPrice.toFixed(4);

                // Adiciona o novo preço ao gráfico
                if (dayTradeChart) {
                    const chartData = dayTradeChart.data.datasets[0].data;
                    chartData.push({ x: Date.now(), y: newPrice });

                    // Remove o ponto mais antigo se o limite for atingido
                    if (chartData.length > MAX_CHART_POINTS) {
                        chartData.shift();
                    }
                    dayTradeChart.update('none');
                }

                // Recalcula PnL se houver posição aberta
                if (dayTradeState.position !== 'FLAT') {
                    calculateOpenPnl();
                    updatePositionUI();
                }

            } catch (error) {
                console.error("Erro ao buscar cotação do dólar:", error);
                ui.currentPriceDisplay.textContent = "Erro";
            }
        }
        
        function resetDayTradeState() {
            dayTradeState = {
                position: 'FLAT', quantity: 0, avgPrice: 0, openPnl: 0, closedPnl: 0, currentPrice: 0,
                contractSize: 1, // Para dólar spot, 1 unidade = 1 dólar. O lucro é em BRL.
                currency: 'BRL',
            };
            updatePositionUI();
        }

        function setupDayTradeChart() {
            const ctx = ui.dayTradeChart.getContext('2d');
            if (dayTradeChart) {
                dayTradeChart.destroy();
            }
            
            dayTradeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cotação USD/BRL',
                        data: [],
                        borderColor: '#facc15', // Amarelo
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', displayFormats: { minute: 'HH:mm:ss' } },
                            ticks: { color: '#d1d5db' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#d1d5db', callback: (value) => value.toFixed(4) },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function executeTrade(type, forcedQuantity = null) {
            const quantity = forcedQuantity || parseInt(ui.orderQuantity.value);
            const price = dayTradeState.currentPrice;
            if (quantity <= 0 || price <= 0) return;

            const currentPosition = dayTradeState.position;
            const currentQty = dayTradeState.quantity;
            
            if (type === 'BUY') {
                if (currentPosition === 'FLAT') {
                    dayTradeState.position = 'LONG';
                    dayTradeState.avgPrice = price;
                    dayTradeState.quantity = quantity;
                } else if (currentPosition === 'LONG') {
                    dayTradeState.avgPrice = ((dayTradeState.avgPrice * currentQty) + (price * quantity)) / (currentQty + quantity);
                    dayTradeState.quantity += quantity;
                } else { // SHORT
                    const qtyToClose = Math.min(quantity, currentQty);
                    const remainingQty = quantity - qtyToClose;
                    closePosition(price, qtyToClose);
                    if (remainingQty > 0) {
                        dayTradeState.position = 'LONG';
                        dayTradeState.avgPrice = price;
                        dayTradeState.quantity = remainingQty;
                    }
                }
            } else if (type === 'SELL') {
                 if (currentPosition === 'FLAT') {
                    dayTradeState.position = 'SHORT';
                    dayTradeState.avgPrice = price;
                    dayTradeState.quantity = quantity;
                } else if (currentPosition === 'SHORT') {
                    dayTradeState.avgPrice = ((dayTradeState.avgPrice * currentQty) + (price * quantity)) / (currentQty + quantity);
                    dayTradeState.quantity += quantity;
                } else { // LONG
                    const qtyToClose = Math.min(quantity, currentQty);
                    const remainingQty = quantity - qtyToClose;
                    closePosition(price, qtyToClose);
                    if (remainingQty > 0) {
                        dayTradeState.position = 'SHORT';
                        dayTradeState.avgPrice = price;
                        dayTradeState.quantity = remainingQty;
                    }
                }
            }
            updatePositionUI();
        }

        function closePosition(price, qtyToClose = dayTradeState.quantity) {
            if (dayTradeState.position === 'FLAT' || qtyToClose <= 0) return;
            
            const pnl = (dayTradeState.position === 'LONG') 
                ? (price - dayTradeState.avgPrice) * qtyToClose * dayTradeState.contractSize
                : (dayTradeState.avgPrice - price) * qtyToClose * dayTradeState.contractSize;

            dayTradeState.closedPnl += pnl;
            dayTradeState.quantity -= qtyToClose;

            if (dayTradeState.quantity <= 0) {
                dayTradeState.position = 'FLAT';
                dayTradeState.quantity = 0;
                dayTradeState.avgPrice = 0;
                dayTradeState.openPnl = 0;
            }
            updatePositionUI();
        }
        
        function calculateOpenPnl() {
            if (dayTradeState.position === 'FLAT') {
                dayTradeState.openPnl = 0;
                return;
            }
            const price = dayTradeState.currentPrice;
            const pnl = (dayTradeState.position === 'LONG')
                ? (price - dayTradeState.avgPrice) * dayTradeState.quantity * dayTradeState.contractSize
                : (dayTradeState.avgPrice - price) * dayTradeState.quantity * dayTradeState.contractSize;
            dayTradeState.openPnl = pnl;
        }

        function updatePositionUI() {
            const { position, quantity, avgPrice, openPnl, closedPnl, currency } = dayTradeState;
            ui.posStatus.textContent = position === 'LONG' ? 'Comprado' : position === 'SHORT' ? 'Vendido' : 'Zerado';
            ui.posQuantity.textContent = quantity;
            ui.posAvgPrice.textContent = avgPrice.toFixed(4);
            
            const fmtr = (v) => formatCurrency(v, currency);
            ui.posOpenPnl.textContent = fmtr(openPnl);
            ui.posOpenPnl.className = `font-bold text-lg day-trade-info-value ${openPnl >= 0 ? 'positive' : 'negative'}`;
            
            ui.posClosedPnl.textContent = fmtr(closedPnl);
            ui.posClosedPnl.className = `font-bold text-lg day-trade-info-value ${closedPnl >= 0 ? 'positive' : 'negative'}`;
        }

        function formatCurrency(value, currency = 'BRL') { 
            return new Intl.NumberFormat(currency === 'USD' ? 'en-US' : 'pt-BR', { style: 'currency', currency }).format(value); 
        }

        ui.buyBtn.addEventListener('click', () => executeTrade('BUY'));
        ui.sellBtn.addEventListener('click', () => executeTrade('SELL'));
        ui.closePositionBtn.addEventListener('click', () => closePosition(dayTradeState.currentPrice));
        ui.reversePositionBtn.addEventListener('click', () => {
            if (dayTradeState.position === 'FLAT') return;
            const qtyToReverse = dayTradeState.quantity * 2;
            const tradeType = dayTradeState.position === 'LONG' ? 'SELL' : 'BUY';
            executeTrade(tradeType, qtyToReverse);
        });
    </script>
</body>
</html>