<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Day Trade - Conexão Cedro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .loader {
            border: 4px solid #4b5563; border-top: 4px solid #6366f1; border-radius: 50%;
            width: 48px; height: 48px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-container { position: relative; height: 70vh; width: 100%; }
        .day-trade-info-value.positive { color: #22c55e; }
        .day-trade-info-value.negative { color: #ef4444; }
        .status-dot {
            height: 12px; width: 12px; border-radius: 50%; display: inline-block;
            transition: background-color 0.3s;
        }
        .status-dot.connected { background-color: #22c55e; }
        .status-dot.disconnected { background-color: #ef4444; }
        .status-dot.connecting { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8">

    <!-- TELA DE CARREGAMENTO / AUTENTICAÇÃO -->
    <div id="loadingScreen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="text-center max-w-2xl">
            <div class="loader inline-block"></div>
            <div id="loadingStatus" class="text-gray-400 mt-4 text-lg">Aguardando autenticação...</div>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL DA APLICAÇÃO -->
    <div id="appContainer" class="hidden">
        <header class="max-w-7xl mx-auto mb-6 relative flex justify-between items-center">
            <div>
                <h1 id="mainTitle" class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">Terminal de Commodities</h1>
                <p class="text-gray-400 text-sm">Conectado via Cedro Technologies</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="connectionStatus" class="bg-gray-800 p-3 rounded-lg text-sm flex items-center gap-3">
                    <span id="statusDot" class="status-dot connecting"></span>
                    <span id="statusText" class="font-mono">Conectando...</span>
                </div>
                 <div class="text-right">
                    <p id="userEmail" class="text-xs text-gray-500 mb-1"></p>
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-lg inline-flex items-center transition">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <div id="dayTradePage" class="max-w-7xl mx-auto mt-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Coluna do Gráfico -->
                <div class="lg:col-span-3 bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 id="chartTitle" class="font-semibold text-lg mb-4 text-center text-gray-200">Selecione um ativo para começar</h3>
                    <div id="chartContainer" class="chart-container"></div>
                </div>

                <!-- Coluna da Boleta e Posição -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Seletor de Ativos -->
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                        <label for="assetSelector" class="block mb-2 text-sm font-medium text-gray-300">Selecione o Ativo</label>
                        <select id="assetSelector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="">-- Commodities --</option>
                            <option value="BGI">Boi Gordo (BGI)</option>
                            <option value="ICF">Café Arábica (ICF)</option>
                            <option value="CCM">Milho (CCM)</option>
                            <option value="SFI">Soja (SFI)</option>
                        </select>
                    </div>

                    <!-- Boleta de Ordens -->
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-lg mb-4 text-gray-200">Boleta de Ordens</h3>
                        <div class="bg-gray-900/50 p-3 rounded-lg text-center mb-4">
                            <p class="text-sm text-gray-400">Preço Atual</p>
                            <p id="currentPriceDisplay" class="text-2xl font-bold font-mono text-yellow-400">--.--</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label for="orderQuantity" class="block mb-1 text-sm font-medium text-gray-300">Quantidade (Contratos)</label>
                                <input type="number" id="orderQuantity" value="1" min="1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                            <div class="flex gap-3">
                                <button id="buyBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50" disabled>COMPRAR</button>
                                <button id="sellBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50" disabled>VENDER</button>
                            </div>
                            <div class="flex gap-3 pt-2">
                                 <button id="closePositionBtn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg transition disabled:opacity-50" disabled>ZERAR</button>
                                 <button id="reversePositionBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg transition disabled:opacity-50" disabled>REVERTER</button>
                            </div>
                        </div>
                    </div>

                    <!-- Posição Atual -->
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-lg mb-4 text-gray-200">Posição Atual</h3>
                        <div id="positionInfo" class="space-y-2 text-sm">
                            <div class="flex justify-between items-center"><span class="text-gray-400">Posição:</span><span id="posStatus" class="font-semibold">Zerado</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400">Quantidade:</span><span id="posQuantity" class="font-semibold">0</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400">Preço Médio:</span><span id="posAvgPrice" class="font-semibold font-mono">0.00</span></div>
                            <hr class="border-gray-700 my-2">
                            <div class="flex justify-between items-center"><span class="text-gray-400">Resultado Aberto:</span><span id="posOpenPnl" class="font-bold text-lg font-mono day-trade-info-value">R$ 0,00</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400">Resultado do Dia:</span><span id="posClosedPnl" class="font-bold text-lg font-mono day-trade-info-value">R$ 0,00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // --- CONFIGURAÇÕES ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMIdzeoPFrT8WRElUBes7GTrcsoGzLBiI",
            authDomain: "backtest-f5072.firebaseapp.com",
            projectId: "backtest-f5072",
            storageBucket: "backtest-f5072.appspot.com",
            messagingSenderId: "694914388064",
            appId: "1:694914388064:web:e5ac46c00612142d33b305",
            measurementId: "G-YD1CYX3455"
        };
        const WEBSOCKET_URL = 'ws://localhost:3000';
        const AGGREGATION_MINUTES = 1;
        // ---------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let priceChart, candlestickSeries, webSocket;
        let currentCandle = null;
        let dayTradeState = {};
        
        const markets = {
            'BGI': { name: 'Boi Gordo', contractSize: 330 },
            'ICF': { name: 'Café Arábica', contractSize: 100 },
            'CCM': { name: 'Milho', contractSize: 450 },
            'SFI': { name: 'Soja', contractSize: 450 }
        };

        const ui = {
            loadingScreen: document.getElementById('loadingScreen'),
            loadingStatus: document.getElementById('loadingStatus'),
            appContainer: document.getElementById('appContainer'),
            userEmail: document.getElementById('userEmail'),
            logoutBtn: document.getElementById('logoutBtn'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            chartContainer: document.getElementById('chartContainer'),
            chartTitle: document.getElementById('chartTitle'),
            assetSelector: document.getElementById('assetSelector'),
            currentPriceDisplay: document.getElementById('currentPriceDisplay'),
            orderQuantity: document.getElementById('orderQuantity'),
            buyBtn: document.getElementById('buyBtn'),
            sellBtn: document.getElementById('sellBtn'),
            closePositionBtn: document.getElementById('closePositionBtn'),
            reversePositionBtn: document.getElementById('reversePositionBtn'),
            posStatus: document.getElementById('posStatus'),
            posQuantity: document.getElementById('posQuantity'),
            posAvgPrice: document.getElementById('posAvgPrice'),
            posOpenPnl: document.getElementById('posOpenPnl'),
            posClosedPnl: document.getElementById('posClosedPnl'),
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                ui.userEmail.textContent = user.email;
                ui.loadingStatus.textContent = "Autenticado. Iniciando terminal...";
                setTimeout(() => {
                    ui.loadingScreen.classList.add('hidden');
                    ui.appContainer.classList.remove('hidden');
                    initializeAppLogic();
                }, 1000);
            } else {
                window.location.href = './index.html';
            }
        });
        
        function initializeAppLogic() {
            setupChart();
            resetDayTradeState();
            connectToServer();
        }

        ui.logoutBtn.addEventListener('click', () => signOut(auth));

        function connectToServer() {
            webSocket = new WebSocket(WEBSOCKET_URL);

            webSocket.onopen = () => {
                updateConnectionStatus('connected', 'Conectado. Aguardando autenticação...');
            };

            webSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'tick') {
                    dayTradeState.currentPrice = data.price;
                    updateUIWithNewPrice(data.price);
                    aggregateTick(data);
                } else if (data.type === 'auth_success') {
                    console.log('Backend autenticado na Cedro.');
                    // MUDANÇA: Seleciona e se inscreve automaticamente no primeiro ativo (BGI)
                    const defaultAsset = 'BGI';
                    ui.assetSelector.value = defaultAsset;
                    const event = new Event('change');
                    ui.assetSelector.dispatchEvent(event);
                }
            };

            webSocket.onclose = () => {
                updateConnectionStatus('disconnected', 'Desconectado. Reconectando...');
                dayTradeState.currentPrice = 0;
                disableTradingButtons();
                setTimeout(connectToServer, 3000);
            };

            webSocket.onerror = (error) => {
                updateConnectionStatus('disconnected', 'Erro de conexão.');
                webSocket.close();
            };
        }

        function setupChart() {
            priceChart = LightweightCharts.createChart(ui.chartContainer, {
                layout: { backgroundColor: '#1f2937', textColor: '#d1d5db' },
                grid: { vertLines: { color: '#374151' }, horzLines: { color: '#374151' } },
                rightPriceScale: { borderColor: '#4b5563' },
                timeScale: { borderColor: '#4b5563', timeVisible: true, secondsVisible: false },
                localization: { locale: 'pt-BR' }
            });
            candlestickSeries = priceChart.addCandlestickSeries({
                upColor: '#22c55e', downColor: '#ef4444',
                borderVisible: false, wickUpColor: '#22c55e', wickDownColor: '#ef4444',
            });
             window.addEventListener('resize', () => {
                if (ui.chartContainer.clientWidth > 0) {
                   priceChart.resize(ui.chartContainer.clientWidth, ui.chartContainer.clientHeight);
                }
            });
        }
        
        function resetChart() {
            candlestickSeries.setData([]);
            currentCandle = null;
        }

        function aggregateTick(data) {
            const intervalMs = AGGREGATION_MINUTES * 60 * 1000;
            const candleTimestamp = Math.floor(data.timestamp / intervalMs) * intervalMs / 1000;
            
            if (!currentCandle || currentCandle.time !== candleTimestamp) {
                currentCandle = {
                    time: candleTimestamp, open: data.price, high: data.price, low: data.price, close: data.price,
                };
            } else {
                currentCandle.high = Math.max(currentCandle.high, data.price);
                currentCandle.low = Math.min(currentCandle.low, data.price);
                currentCandle.close = data.price;
            }
            candlestickSeries.update(currentCandle);
        }

        function resetDayTradeState() {
            const selectedSymbol = ui.assetSelector.value;
            const market = markets[selectedSymbol] || { name: 'N/A', contractSize: 1 };

            dayTradeState = {
                position: 'FLAT', quantity: 0, avgPrice: 0, openPnl: 0, closedPnl: 0, currentPrice: 0,
                contractSize: market.contractSize,
                currency: 'BRL',
            };
            updatePositionUI();
        }
        
        function updateUIWithNewPrice(price) {
            if (price > 0 && ui.buyBtn.disabled) {
                enableTradingButtons();
            }
            ui.currentPriceDisplay.textContent = price.toFixed(2);
            calculateOpenPnl();
            updatePositionUI();
        }

        function executeTrade(type, forcedQuantity = null) {
            const quantity = forcedQuantity || parseInt(ui.orderQuantity.value);
            const price = dayTradeState.currentPrice;
            if (quantity <= 0 || price <= 0) return;

            const currentPosition = dayTradeState.position;
            const currentQty = dayTradeState.quantity;
            
            if (type === 'BUY') {
                if (currentPosition === 'FLAT') {
                    dayTradeState.position = 'LONG';
                    dayTradeState.avgPrice = price;
                    dayTradeState.quantity = quantity;
                } else if (currentPosition === 'LONG') {
                    dayTradeState.avgPrice = ((dayTradeState.avgPrice * currentQty) + (price * quantity)) / (currentQty + quantity);
                    dayTradeState.quantity += quantity;
                } else { // SHORT
                    const qtyToClose = Math.min(quantity, currentQty);
                    const remainingQty = quantity - qtyToClose;
                    closePosition(price, qtyToClose);
                    if (remainingQty > 0) {
                        dayTradeState.position = 'LONG';
                        dayTradeState.avgPrice = price;
                        dayTradeState.quantity = remainingQty;
                    }
                }
            } else if (type === 'SELL') {
                 if (currentPosition === 'FLAT') {
                    dayTradeState.position = 'SHORT';
                    dayTradeState.avgPrice = price;
                    dayTradeState.quantity = quantity;
                } else if (currentPosition === 'SHORT') {
                    dayTradeState.avgPrice = ((dayTradeState.avgPrice * currentQty) + (price * quantity)) / (currentQty + quantity);
                    dayTradeState.quantity += quantity;
                } else { // LONG
                    const qtyToClose = Math.min(quantity, currentQty);
                    const remainingQty = quantity - qtyToClose;
                    closePosition(price, qtyToClose);
                    if (remainingQty > 0) {
                        dayTradeState.position = 'SHORT';
                        dayTradeState.avgPrice = price;
                        dayTradeState.quantity = remainingQty;
                    }
                }
            }
            updatePositionUI();
        }

        function closePosition(price, qtyToClose = dayTradeState.quantity) {
            if (dayTradeState.position === 'FLAT' || qtyToClose <= 0) return;
            
            const pnl = (dayTradeState.position === 'LONG') 
                ? (price - dayTradeState.avgPrice) * qtyToClose * dayTradeState.contractSize
                : (dayTradeState.avgPrice - price) * qtyToClose * dayTradeState.contractSize;

            dayTradeState.closedPnl += pnl;
            dayTradeState.quantity -= qtyToClose;

            if (dayTradeState.quantity <= 0) {
                dayTradeState.position = 'FLAT';
                dayTradeState.quantity = 0;
                dayTradeState.avgPrice = 0;
                dayTradeState.openPnl = 0;
            }
            updatePositionUI();
        }
        
        function calculateOpenPnl() {
            if (dayTradeState.position === 'FLAT') {
                dayTradeState.openPnl = 0;
                return;
            }
            const price = dayTradeState.currentPrice;
            const pnl = (dayTradeState.position === 'LONG')
                ? (price - dayTradeState.avgPrice) * dayTradeState.quantity * dayTradeState.contractSize
                : (dayTradeState.avgPrice - price) * dayTradeState.quantity * dayTradeState.contractSize;
            dayTradeState.openPnl = pnl;
        }

        function updatePositionUI() {
            const { position, quantity, avgPrice, openPnl, closedPnl, currency } = dayTradeState;
            ui.posStatus.textContent = position === 'LONG' ? 'Comprado' : position === 'SHORT' ? 'Vendido' : 'Zerado';
            ui.posQuantity.textContent = quantity;
            ui.posAvgPrice.textContent = avgPrice.toFixed(2);
            
            const fmtr = (v) => formatCurrency(v, currency);
            ui.posOpenPnl.textContent = fmtr(openPnl);
            ui.posOpenPnl.className = `font-bold text-lg font-mono day-trade-info-value ${openPnl >= 0 ? 'positive' : 'negative'}`;
            
            ui.posClosedPnl.textContent = fmtr(closedPnl);
            ui.posClosedPnl.className = `font-bold text-lg font-mono day-trade-info-value ${closedPnl >= 0 ? 'positive' : 'negative'}`;
        }
        
        function subscribeToAsset(symbol) {
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                const command = {
                    action: 'subscribe',
                    symbol: symbol
                };
                webSocket.send(JSON.stringify(command));
                updateConnectionStatus('connected', `Inscrito em ${symbol}. Aguardando ticks...`);
            } else {
                console.warn('WebSocket não está aberto. Inscrição falhou.');
            }
        }

        function updateConnectionStatus(status, text) {
            ui.statusDot.className = `status-dot ${status}`;
            ui.statusText.textContent = text;
        }
        function enableTradingButtons() {
            [ui.buyBtn, ui.sellBtn, ui.closePositionBtn, ui.reversePositionBtn].forEach(btn => btn.disabled = false);
        }
        function disableTradingButtons() {
            [ui.buyBtn, ui.sellBtn, ui.closePositionBtn, ui.reversePositionBtn].forEach(btn => btn.disabled = true);
        }
        function formatCurrency(value, currency = 'BRL') { 
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency }).format(value); 
        }

        ui.assetSelector.addEventListener('change', (event) => {
            const selectedSymbol = event.target.value;
            if (selectedSymbol) {
                const selectedAssetName = event.target.options[event.target.selectedIndex].text;
                ui.chartTitle.textContent = `Gráfico Intraday (1 min) - ${selectedAssetName}`;
                resetChart();
                resetDayTradeState();
                subscribeToAsset(selectedSymbol);
            } else {
                ui.chartTitle.textContent = 'Selecione um ativo para começar';
                disableTradingButtons();
                resetChart();
            }
        });

        ui.buyBtn.addEventListener('click', () => executeTrade('BUY'));
        ui.sellBtn.addEventListener('click', () => executeTrade('SELL'));
        ui.closePositionBtn.addEventListener('click', () => closePosition(dayTradeState.currentPrice));
        ui.reversePositionBtn.addEventListener('click', () => {
            if (dayTradeState.position === 'FLAT') return;
            const qtyToReverse = dayTradeState.quantity * 2;
            const tradeType = dayTradeState.position === 'LONG' ? 'SELL' : 'BUY';
            executeTrade(tradeType, qtyToReverse);
        });

    </script>
</body>
</html>
